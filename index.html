<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juegos de Memoria y Escritura - Multijugador</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background: linear-gradient(to bottom, #ff0000, #add8e6);
            margin: 0;
            min-height: 100vh;
        }

        h1 { color: #333; margin: 20px 0; }
        
        .screen {
            display: none;
            padding: 20px;
            min-height: 100vh;
        }
        
        .screen.active { display: block; }

        /* Rules Screen */
        .rules-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 800px;
            margin: 50px auto;
            text-align: left;
        }

        .rules-container h1 {
            text-align: center;
            color: #333;
            font-size: 2.5em;
        }

        .rules-container ol {
            font-size: 1.1em;
            line-height: 1.8;
            color: #444;
        }

        .rules-container li { margin-bottom: 15px; }

        .btn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn-start {
            font-size: 20px;
            padding: 20px 40px;
            display: block;
            margin: 30px auto;
        }

        /* Setup Screen */
        .setup-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 600px;
            margin: 50px auto;
        }

        .participant-input {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }

        .participant-input input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            width: 250px;
        }

        .participants-list {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .participant-item {
            background: white;
            padding: 8px 15px;
            margin: 5px 0;
            border-radius: 20px;
            border: 1px solid #ddd;
        }

        /* Roulette */
        .roulette-container {
            margin: 30px auto;
            position: relative;
        }

        .arrow {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 30px solid red;
            z-index: 10;
        }

        .roulette {
            width: 300px;
            height: 300px;
            border-radius: 50%;
            position: relative;
            margin: 0 auto;
            border: 5px solid #333;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            transition: transform 3s ease-out;
        }

        /* Game Screens */
        .timer {
            font-size: 28px;
            font-weight: bold;
            color: #ff0000;
            margin: 15px 0;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 25px;
            border-radius: 25px;
            display: inline-block;
        }

        .player-info {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 15px;
            margin: 20px auto;
            max-width: 700px;
        }

        .current-player {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .scores {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }

        .score-item {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 16px;
        }

        /* Memory Games */
        .memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            max-width: 500px;
            margin: 30px auto;
            justify-items: center;
        }

        .memory-card {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #ddd;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            border: 4px solid #333;
            transition: all 0.3s ease;
            position: relative;
        }

        .memory-card:hover:not(.matched) {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .memory-card.flipped {
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .memory-card.matched {
            border-color: gold;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            opacity: 0.7;
            pointer-events: none;
        }

        /* Color specific styles */
        .color-rojo-oscuro { background-color: darkred; }
        .color-azul-oscuro { background-color: darkblue; }
        .color-verde-oscuro { background-color: darkgreen; }
        .color-amarillo-oscuro { background-color: #B8860B; }
        .color-morado-oscuro { background-color: darkmagenta; }
        .color-gris-oscuro { background-color: dimgray; }

        /* Animal and emotion cards */
        .memory-card.animal, .memory-card.emotion {
            font-size: 50px;
            background-color: white;
            color: #333;
        }

        /* Writing Games */
        .writing-display {
            width: 250px;
            height: 250px;
            border-radius: 50%;
            margin: 30px auto;
            border: 5px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            font-weight: bold;
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .writing-display.color {
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .input-section {
            margin: 30px 0;
        }

        .answer-input {
            padding: 20px;
            font-size: 20px;
            border: 3px solid #ddd;
            border-radius: 25px;
            width: 400px;
            text-align: center;
            margin: 15px;
        }

        .answer-input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .submit-btn {
            padding: 20px 40px;
            font-size: 20px;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            margin: 15px;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .feedback {
            font-size: 20px;
            font-weight: bold;
            margin: 20px 0;
            padding: 20px;
            border-radius: 15px;
        }

        .feedback.correct {
            background-color: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .feedback.incorrect {
            background-color: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        /* Final Results */
        .results-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            margin: 30px auto;
            max-width: 800px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .results-table th, .results-table td {
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid #ddd;
            font-size: 16px;
        }

        .results-table th {
            background: #4CAF50;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .winner-row {
            background: #fff3cd;
            font-weight: bold;
            border: 2px solid #ffc107;
        }

        /* Admin Panel */
        .admin-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: rgba(255, 107, 53, 0.9);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            z-index: 1000;
        }

        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #000, #00f);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .login-box {
            background: rgba(0, 0, 0, 0.9);
            padding: 40px;
            border-radius: 20px;
            color: white;
            text-align: center;
            min-width: 400px;
        }

        .login-field {
            margin: 20px 0;
            text-align: left;
        }

        .login-field label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .login-field input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            box-sizing: border-box;
        }

        /* Visual Tools Modal */
        .visual-tools-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .visual-tools-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .visual-tools-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        .visual-tools-section h4 {
            margin-top: 0;
            color: #333;
        }

        .admin-select, .admin-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        /* Login screen snow animation */
        .snow {
            position: absolute;
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: fall linear infinite;
            opacity: 0.8;
        }

        @keyframes fall {
            from {
                top: -10px;
                opacity: 1;
            }
            to {
                top: 100%;
                opacity: 0;
            }
        }

        /* Estilos para el perfil de usuario */
        .profile-container {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 20px;
            margin: 20px auto;
            max-width: 500px;
        }
        
        .profile-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .profile-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: #666;
            cursor: pointer;
            overflow: hidden;
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .avatar-option {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .avatar-option:hover, .avatar-option.selected {
            border-color: #ff9800;
            transform: scale(1.1);
        }
        
        /* Fin de estilos para perfil */

        function crearSala() {
            const roomName = document.getElementById('room-name').value.trim();
            const hostName = document.getElementById('host-name').value.trim();
            const maxPlayers = parseInt(document.getElementById('max-players').value);

            if (!roomName || !hostName) {
                alert('Por favor completa todos los campos');
                return;
            }

            // Generar c√≥digo √∫nico de sala
            roomCode = generarCodigoSala();
            
            // Configurar sala
            currentRoom = {
                code: roomCode,
                name: roomName,
                host: hostName,
                maxPlayers: maxPlayers,
                players: [hostName]
            };

            // Configurar multijugador
            isMultiplayer = true;
            isHost = true;
            participants = [hostName];
            scores = [0];
            errors = [0];
            multiplayerPlayers = [{ name: hostName, isHost: true, connected: true }];

            // Agregar sala a las salas simuladas para que otros puedan unirse
            simulatedRooms.push({
                code: roomCode,
                name: roomName,
                host: hostName,
                maxPlayers: maxPlayers,
                players: 1
            });

            // Mostrar lobby
            mostrarLobby();

            // Simular que otros jugadores se pueden unir
            simularConexionesMultijugador();
        }

        function unirseASala() {
            const roomCodeInput = document.getElementById('room-code').value.trim().toUpperCase();
            const playerName = document.getElementById('player-name').value.trim();

            if (!roomCodeInput || !playerName) {
                alert('Por favor completa todos los campos');
                return;
            }

            // Buscar sala (simulado)
            const foundRoom = simulatedRooms.find(room => room.code === roomCodeInput);
            
            if (!foundRoom) {
                alert('C√≥digo de sala no v√°lido. Verifica el c√≥digo e intenta nuevamente.');
                return;
            }

            if (foundRoom.players >= foundRoom.maxPlayers) {
                alert('La sala est√° llena. Intenta con otra sala.');
                return;
            }

            // Unirse a la sala
            roomCode = roomCodeInput;
            currentRoom = {
                code: roomCode,
                name: foundRoom.name,
                host: foundRoom.host,
                maxPlayers: foundRoom.maxPlayers,
                players: [foundRoom.host, playerName]
            };

            isMultiplayer = true;
            isHost = false;
            participants = currentRoom.players;
            scores = new Array(participants.length).fill(0);
            errors = new Array(participants.length).fill(0);
            multiplayerPlayers = [
                { name: foundRoom.host, isHost: true, connected: true },
                { name: playerName, isHost: false, connected: true }
            ];

            mostrarLobby();
            simularConexionesMultijugador();
        }

        function buscarSalas() {
            const availableRoomsContainer = document.getElementById('available-rooms');
            
            // Simular b√∫squeda
            availableRoomsContainer.innerHTML = '<p style="color: #666; font-style: italic;">Buscando salas...</p>';
            
            setTimeout(() => {
                if (simulatedRooms.length === 0) {
                    availableRoomsContainer.innerHTML = '<p style="color: #666; font-style: italic;">No hay salas disponibles en este momento.</p>';
                    return;
                }

                availableRoomsContainer.innerHTML = simulatedRooms.map(room => `
                    <div style="background: white; padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid #ddd; cursor: pointer; transition: all 0.3s ease;" onclick="seleccionarSala('${room.code}', '${room.name}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${room.name}</strong>
                                <br><span style="color: #666; font-size: 14px;">Anfitri√≥n: ${room.host}</span>
                            </div>
                            <div style="text-align: right;">
                                <div style="background: #e3f2fd; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; color: #1976d2;">
                                    ${room.code}
                                </div>
                                <div style="margin-top: 5px; font-size: 14px; color: ${room.players < room.maxPlayers ? '#28a745' : '#dc3545'};">
                                    ${room.players}/${room.maxPlayers} jugadores
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }, 1000);
        }

        function seleccionarSala(code, name) {
            document.getElementById('room-code').value = code;
            // Highlighting effect
            event.target.style.background = '#e3f2fd';
            setTimeout(() => {
                event.target.style.background = 'white';
            }, 500);
        }

        function mostrarLobby() { 
            showScreen('multiplayer-lobby-screen'); 
            actualizarLobby(); 
            
            // Mostrar notificaci√≥n con el c√≥digo de sala 
            mostrarNotificacionMultijugador(`üîë C√≥digo de sala: ${roomCode}`); 
            
            // Actualizar el lobby cada 5 segundos para reflejar cambios
            const intervaloActualizacion = setInterval(() => {
                if (currentRoom) {
                    actualizarLobby();
                } else {
                    clearInterval(intervaloActualizacion);
                }
            }, 5000);
         }

        function actualizarLobby() {
            document.getElementById('lobby-title').textContent = `üè† Sala: ${currentRoom.name}`;
            document.getElementById('room-code-display').textContent = roomCode;
            document.getElementById('player-count').textContent = multiplayerPlayers.length;
            document.getElementById('max-player-count').textContent = currentRoom.maxPlayers;

            // Mostrar estado de la sala
            const estadoSala = document.createElement('div');
            estadoSala.className = 'room-status';
            estadoSala.innerHTML = `
                <div style="background: ${multiplayerPlayers.length >= 2 ? '#e8f5e9' : '#fff3e0'}; padding: 10px 15px; border-radius: 8px; margin: 10px 0; border-left: 5px solid ${multiplayerPlayers.length >= 2 ? '#4caf50' : '#ff9800'};">
                    <p style="margin: 0; font-weight: bold; color: ${multiplayerPlayers.length >= 2 ? '#2e7d32' : '#ef6c00'};">
                        ${multiplayerPlayers.length >= 2 ? '‚úÖ Sala lista para comenzar' : '‚è≥ Esperando m√°s jugadores'}
                    </p>
                    <p style="margin: 5px 0 0 0; font-size: 14px; color: #666;">
                        ${isHost ? 'Eres el anfitri√≥n de esta sala' : 'Esperando que el anfitri√≥n inicie el juego'}
                    </p>
                </div>
            `;
            
            // Reemplazar o agregar el estado de la sala
            const estadoExistente = document.querySelector('.room-status');
            if (estadoExistente) {
                estadoExistente.replaceWith(estadoSala);
            } else {
                document.getElementById('lobby-info').appendChild(estadoSala);
            }

            const playersContainer = document.getElementById('lobby-players');
            playersContainer.innerHTML = multiplayerPlayers.map((player, index) => `
                <div class="player-item" style="background: white; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">${player.isHost ? 'üëë' : 'üë§'}</span>
                        <span style="font-weight: bold;">${player.name}</span>
                        ${player.isHost ? '<span style="background: #ffc107; color: #212529; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">ANFITRI√ìN</span>' : ''}
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="connection-status" style="color: ${player.connected ? '#28a745' : '#dc3545'}; font-size: 12px; display: flex; align-items: center; gap: 5px;">
                            <span class="status-dot" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: ${player.connected ? '#28a745' : '#dc3545'}; animation: ${player.connected ? 'pulse 2s infinite' : 'none'};"></span>
                            ${player.connected ? 'Conectado' : 'Desconectado'}
                        </span>
                    </div>
                </div>
            `).join('');

            // Agregar estilos para la animaci√≥n de pulso si no existen
            if (!document.getElementById('pulse-animation')) {
                const style = document.createElement('style');
                style.id = 'pulse-animation';
                style.textContent = `
                    @keyframes pulse {
                        0% { opacity: 1; }
                        50% { opacity: 0.5; }
                        100% { opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }

            // Habilitar bot√≥n de inicio solo para el anfitri√≥n con m√≠nimo 2 jugadores
            const startBtn = document.getElementById('start-multiplayer-btn');
            if (isHost && multiplayerPlayers.length >= 2) {
                startBtn.disabled = false;
                startBtn.classList.add('btn-active');
                startBtn.textContent = 'üöÄ Iniciar Juego';
            } else if (isHost) {
                startBtn.disabled = true;
                startBtn.classList.remove('btn-active');
                startBtn.textContent = `‚è≥ Esperando jugadores (${multiplayerPlayers.length}/2 m√≠n.)`;
            } else {
                startBtn.disabled = true;
                startBtn.classList.remove('btn-active');
                startBtn.textContent = '‚è≥ Esperando al anfitri√≥n...';
            }
        }

        function simularConexionesMultijugador() {
            // Simular que jugadores adicionales se unen ocasionalmente
            const nombresSimulados = ['Alex', 'Sofia', 'Diego', 'Luna', 'Mateo', 'Isabella', 'Gabriel', 'Valentina'];
            let contadorNombres = 0;

            const intervaloConexion = setInterval(() => {
                if (multiplayerPlayers.length < currentRoom.maxPlayers && Math.random() < 0.3 && contadorNombres < nombresSimulados.length) {
                    const nuevoJugador = {
                        name: nombresSimulados[contadorNombres],
                        isHost: false,
                        connected: true
                    };
                    
                    multiplayerPlayers.push(nuevoJugador);
                    participants.push(nuevoJugador.name);
                    scores.push(0);
                    errors.push(0);
                    contadorNombres++;
                    
                    actualizarLobby();
                    
                    // Notificaci√≥n de nuevo jugador 
                     mostrarNotificacionMultijugador(`üéâ ${nuevoJugador.name} se uni√≥ a la sala`, 'success');
                }
                
                if (multiplayerPlayers.length >= 6 || contadorNombres >= 4) {
                    clearInterval(intervaloConexion);
                }
            }, 5000);
        }

        function mostrarNotificacionMultijugador(mensaje, tipo = 'info') { 
             const notificacion = document.createElement('div');
             
             // Determinar color seg√∫n el tipo de mensaje
             let colorFondo, colorBorde;
             let icono = '';
             
             switch(tipo) {
                 case 'success':
                     colorFondo = '#28a745';
                     colorBorde = '#1e7e34';
                     icono = '‚úÖ ';
                     break;
                 case 'warning':
                     colorFondo = '#ffc107';
                     colorBorde = '#d39e00';
                     icono = '‚ö†Ô∏è ';
                     break;
                 case 'error':
                     colorFondo = '#dc3545';
                     colorBorde = '#bd2130';
                     icono = '‚ùå ';
                     break;
                 case 'info':
                 default:
                     colorFondo = '#17a2b8';
                     colorBorde = '#138496';
                     icono = '‚ÑπÔ∏è ';
                     break;
             }
             
             // Si el mensaje ya tiene un emoji al inicio, no a√±adir el icono
             if (mensaje.match(/^[\u{1F300}-\u{1F6FF}\u{2600}-\u{26FF}]/u)) {
                 icono = '';
             }
             
             notificacion.style.cssText = ` 
                 position: fixed; 
                 top: 20px; 
                 right: 20px; 
                 background: ${colorFondo}; 
                 color: white; 
                 padding: 15px 20px; 
                 border-radius: 8px; 
                 border-left: 5px solid ${colorBorde};
                 box-shadow: 0 4px 8px rgba(0,0,0,0.3); 
                 z-index: 5000; 
                 font-weight: bold; 
                 animation: slideIn 0.5s ease-out; 
                 max-width: 80%;
                 word-wrap: break-word;
             `; 
             
             if (!document.getElementById('notification-styles')) { 
                 const style = document.createElement('style'); 
                 style.id = 'notification-styles'; 
                 style.textContent = ` 
                     @keyframes slideIn { 
                         from { transform: translateX(100%); opacity: 0; } 
                         to { transform: translateX(0); opacity: 1; } 
                     } 
                 `; 
                 document.head.appendChild(style); 
             } 
             
             notificacion.textContent = icono + mensaje; 
             document.body.appendChild(notificacion); 
             
             // A√±adir efecto de desvanecimiento antes de eliminar
             setTimeout(() => {
                 notificacion.style.animation = 'fadeOut 0.5s ease-in forwards';
             }, 2500);
             
             setTimeout(() => { 
                 notificacion.remove(); 
             }, 3000); 
             
             // A√±adir animaci√≥n de desvanecimiento si no existe
             if (!document.getElementById('fadeout-styles')) {
                 const fadeStyle = document.createElement('style');
                 fadeStyle.id = 'fadeout-styles';
                 fadeStyle.textContent = `
                     @keyframes fadeOut {
                         from { opacity: 1; }
                         to { opacity: 0; }
                     }
                 `;
                 document.head.appendChild(fadeStyle);
             }
         }

        function iniciarJuegoMultijugador() { 
             if (!isHost) { 
                 alert('Solo el anfitri√≥n puede iniciar el juego'); 
                 return; 
             } 
             
             if (multiplayerPlayers.length < 2) { 
                 alert('Se necesitan al menos 2 jugadores para iniciar'); 
                 return; 
             } 
 
             mostrarNotificacionMultijugador('üöÄ ¬°El juego est√° comenzando!', 'success'); 
             
             // Crear y mostrar la cuenta regresiva
             const cuentaRegresiva = document.createElement('div');
             cuentaRegresiva.className = 'cuenta-regresiva';
             cuentaRegresiva.style.cssText = `
                 position: fixed;
                 top: 0;
                 left: 0;
                 width: 100%;
                 height: 100%;
                 background: rgba(0, 0, 0, 0.7);
                 display: flex;
                 justify-content: center;
                 align-items: center;
                 z-index: 9999;
                 color: white;
                 font-size: 120px;
                 font-weight: bold;
                 text-shadow: 0 0 20px #ff9800;
             `;
             document.body.appendChild(cuentaRegresiva);
             
             // Iniciar la cuenta regresiva
             let contador = 3;
             cuentaRegresiva.textContent = contador;
             
             const intervalo = setInterval(() => {
                 contador--;
                 if (contador > 0) {
                     cuentaRegresiva.textContent = contador;
                     cuentaRegresiva.style.animation = 'pulso 1s';
                 } else if (contador === 0) {
                     cuentaRegresiva.textContent = '¬°COMENZAR!';
                     cuentaRegresiva.style.color = '#4caf50';
                     cuentaRegresiva.style.fontSize = '80px';
                 } else {
                     clearInterval(intervalo);
                     cuentaRegresiva.remove();
                     
                     // Seleccionar jugador inicial aleatoriamente 
                     currentPlayer = Math.floor(Math.random() * participants.length); 
                     startGame(0);
                 }
             }, 1000);
             
             // A√±adir animaci√≥n de pulso si no existe
             if (!document.getElementById('countdown-styles')) {
                 const style = document.createElement('style');
                 style.id = 'countdown-styles';
                 style.textContent = `
                     @keyframes pulso {
                         0% { transform: scale(1); }
                         50% { transform: scale(1.5); }
                         100% { transform: scale(1); }
                     }
                 `;
                 document.head.appendChild(style);
             }
         }


        

        @keyframes snowfall {
            to {
                top: 100vh;
                opacity: 0;
            }
        }
        
        /* Estilos para el multijugador */
        .multiplayer-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 5000;
            font-weight: bold;
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .player-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            max-height: 250px;
            overflow-y: auto;
        }
        
        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .player-host {
            background: #fff3cd;
            border-color: #ffc107;
        }
        
        .player-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected {
            background: #28a745;
        }
        
        .status-disconnected {
            background: #dc3545;
        }
    </style>
</head>
<body>
    <!-- Rules Screen -->
    <div id="rules-screen" class="screen active">
        <div class="rules-container">
            <h1>üéÆ Juegos de Memoria y Escritura - Multijugador</h1>
            <h2>Reglas del Juego:</h2>
            <ol>
                <li><strong>6 Juegos en Total:</strong> 3 juegos de memoria (colores, animales, emociones) y 3 juegos de escritura (ingl√©s/espa√±ol).</li>
                <li><strong>Tiempo por Turno:</strong> Cada jugador tiene 70 segundos para completar su turno en cada juego.</li>
                <li><strong>Juegos de Memoria:</strong> Encuentra parejas de cartas id√©nticas. Cada pareja encontrada otorga 1 punto.</li>
                <li><strong>Juegos de Escritura:</strong> Escribe la traducci√≥n correcta en formato "Ingl√©s / Espa√±ol". Ejemplo: "Dark red / Rojo oscuro"</li>
                <li><strong>Puntuaci√≥n:</strong> Los puntos y nombres se muestran debajo de cada juego. Al final se muestra el total de puntos y errores.</li>
                <li><strong>Multijugador:</strong> Puedes jugar con amigos creando o uni√©ndote a una sala. El anfitri√≥n controla el inicio del juego.</li>
                <li><strong>Respuestas Incorrectas:</strong> Si una respuesta es incorrecta, se mostrar√° la respuesta correcta.</li>
            </ol>
            <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 30px;">
                <button class="btn btn-start" onclick="showSetup()">üöÄ Juego Local</button>
                <button class="btn" onclick="mostrarOpcionesMultijugador()" style="background: linear-gradient(45deg, #28a745, #20c997);">üåê Multijugador</button>
                <button class="btn" onclick="showAdmin()">üë®‚Äçüíº Panel Admin</button>
            </div>
        </div>
    </div>

    <!-- Multiplayer Options Screen -->
    <div id="multiplayer-screen" class="screen">
        <div class="setup-container">
            <h1>üåê Opciones Multijugador</h1>
            
            <!-- Secci√≥n de Perfil de Usuario -->
            <div id="profile-section" class="profile-container">
                <div class="profile-header">
                    <h3>Tu Perfil de Jugador</h3>
                </div>
                <div class="profile-form">
                    <div class="profile-avatar" id="profile-avatar" onclick="toggleAvatarOptions()">
                        <span id="avatar-placeholder">üë§</span>
                    </div>
                    
                    <div class="avatar-options" id="avatar-options" style="display: none;">
                        <div class="avatar-option" data-avatar="üë®" onclick="selectAvatar('üë®')">üë®</div>
                        <div class="avatar-option" data-avatar="üë©" onclick="selectAvatar('üë©')">üë©</div>
                        <div class="avatar-option" data-avatar="üßë" onclick="selectAvatar('üßë')">üßë</div>
                        <div class="avatar-option" data-avatar="üë¶" onclick="selectAvatar('üë¶')">üë¶</div>
                        <div class="avatar-option" data-avatar="üëß" onclick="selectAvatar('üëß')">üëß</div>
                        <div class="avatar-option" data-avatar="üßî" onclick="selectAvatar('üßî')">üßî</div>
                        <div class="avatar-option" data-avatar="üë±‚Äç‚ôÄÔ∏è" onclick="selectAvatar('üë±‚Äç‚ôÄÔ∏è')">üë±‚Äç‚ôÄÔ∏è</div>
                        <div class="avatar-option" data-avatar="üë¥" onclick="selectAvatar('üë¥')">üë¥</div>
                        <div class="avatar-option" data-avatar="üëµ" onclick="selectAvatar('üëµ')">üëµ</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="profile-name">Nombre de Usuario:</label>
                        <input type="text" id="profile-name" placeholder="Tu nombre" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="profile-color">Color Favorito:</label>
                        <input type="color" id="profile-color" value="#ff9800" class="form-control">
                    </div>
                    
                    <button onclick="guardarPerfil()" class="btn btn-primary">Guardar Perfil</button>
                </div>
            </div>
            
            <p style="color: #666; margin: 20px 0;">Juega con amigos en tiempo real conect√°ndote a la misma sala</p>
            
            <div style="display: flex; flex-direction: column; gap: 20px; align-items: center;">
                <button class="btn btn-start" onclick="mostrarCrearSala()" style="width: 300px;">üè† Crear Nueva Sala</button>
                <button class="btn btn-start" onclick="mostrarUnirseSala()" style="width: 300px; background: linear-gradient(45deg, #17a2b8, #138496);">üö™ Unirse a Sala</button>
                <button class="btn" onclick="showScreen('rules-screen')" style="width: 300px; background: linear-gradient(45deg, #6c757d, #5a6268);">‚¨ÖÔ∏è Volver</button>
            </div>
        </div>
    </div>

    <!-- Create Room Screen -->
    <div id="create-room-screen" class="screen">
        <div class="setup-container">
            <h1>üè† Crear Nueva Sala</h1>
            
            <div style="margin: 30px 0;">
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 10px; font-weight: bold;">Nombre de la Sala:</label>
                    <input type="text" id="room-name" placeholder="Mi Sala de Juegos" maxlength="30" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px;">
                </div>
                
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 10px; font-weight: bold;">Tu Nombre:</label>
                    <input type="text" id="host-name" placeholder="Anfitri√≥n" maxlength="20" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px;">
                </div>

                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 10px; font-weight: bold;">M√°ximo de Jugadores:</label>
                    <select id="max-players" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px;">
                        <option value="4">4 Jugadores</option>
                        <option value="6">6 Jugadores</option>
                        <option value="8">8 Jugadores</option>
                        <option value="10" selected>10 Jugadores</option>
                    </select>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-start" onclick="crearSala()">üéÆ Crear Sala</button>
                <button class="btn" onclick="showScreen('multiplayer-screen')" style="background: linear-gradient(45deg, #6c757d, #5a6268);">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Join Room Screen -->
    <div id="join-room-screen" class="screen">
        <div class="setup-container">
            <h1>üö™ Unirse a Sala</h1>
            
            <div style="margin: 30px 0;">
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 10px; font-weight: bold;">C√≥digo de Sala:</label>
                    <input type="text" id="room-code" placeholder="Ejemplo: ABC123" maxlength="10" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; text-transform: uppercase;">
                </div>
                
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 10px; font-weight: bold;">Tu Nombre:</label>
                    <input type="text" id="player-name" placeholder="Jugador" maxlength="20" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px;">
                </div>
            </div>

            <div style="background: #e9ecef; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h3 style="margin-top: 0; color: #495057;">üîç Salas Disponibles:</h3>
                <div id="available-rooms" style="max-height: 200px; overflow-y: auto;">
                    <p style="color: #666; font-style: italic;">Cargando salas disponibles...</p>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-start" onclick="unirseASala()">üéØ Unirse</button>
                <button class="btn" onclick="buscarSalas()" style="background: linear-gradient(45deg, #28a745, #20c997);">üîÑ Actualizar Lista</button>
                <button class="btn" onclick="showScreen('multiplayer-screen')" style="background: linear-gradient(45deg, #6c757d, #5a6268);">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Multiplayer Lobby Screen -->
    <div id="multiplayer-lobby-screen" class="screen">
        <div class="setup-container">
            <div id="lobby-info">
                <h1 id="lobby-title">üè† Sala: Mi Sala</h1>
                <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin: 20px 0;">
                    <p style="margin: 0; font-weight: bold; font-size: 18px; color: #1976d2;">
                        üìã C√≥digo de Sala: <span id="room-code-display">ABC123</span>
                    </p>
                    <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">Comparte este c√≥digo con tus amigos para que se unan</p>
                </div>
            </div>

            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h3 style="margin-top: 0; color: #333;">üë• Jugadores en la Sala (<span id="player-count">1</span>/<span id="max-player-count">10</span>):</h3>
                <div id="lobby-players" style="max-height: 250px; overflow-y: auto;">
                    <!-- Players will be populated here -->
                </div>
            </div>

            <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin: 20px 0; border: 2px solid #ffc107;">
                <h4 style="margin-top: 0; color: #856404;">‚ö†Ô∏è Estado de la Conexi√≥n</h4>
                <p id="connection-status" style="margin: 0; color: #856404;">üü¢ Conectado - Esperando jugadores...</p>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-start" onclick="iniciarJuegoMultijugador()" id="start-multiplayer-btn" disabled>üöÄ Iniciar Juego</button>
                <button class="btn" onclick="salirDeSala()" style="background: linear-gradient(45deg, #dc3545, #c82333);">üö™ Salir de la Sala</button>
            </div>
        </div>
    </div>
    <div id="setup-screen" class="screen">
        <div class="setup-container">
            <h1>üë• Agregar Participantes</h1>
            <div class="participant-input">
                <input type="text" id="participant-name" placeholder="Nombre del participante" maxlength="20">
                <button class="btn" onclick="addParticipant()">Agregar</button>
            </div>
            <div class="participants-list">
                <h3>Participantes:</h3>
                <div id="participants-container">
                    <p>No hay participantes agregados</p>
                </div>
            </div>
            <button class="btn btn-start" onclick="startRoulette()" id="start-roulette-btn" disabled>üé∞ Girar Ruleta</button>
        </div>
    </div>

    <!-- Roulette Screen -->
    <div id="roulette-screen" class="screen">
        <h1>üé∞ Ruleta para Elegir Qui√©n Inicia</h1>
        <div class="roulette-container">
            <div class="arrow"></div>
            <div class="roulette" id="roulette">
                <svg width="300" height="300" viewBox="0 0 300 300" id="roulette-svg">
                </svg>
            </div>
            <button class="btn btn-start" onclick="spinRoulette()">üé≤ Girar Ruleta</button>
        </div>
        <div id="roulette-result"></div>
    </div>

    <!-- Memory Game 1: Colors -->
    <div id="memory-colors" class="screen">
        <div class="game-progress">Juego 1 de 6: Memoria de Colores Oscuros</div>
        <h1>üé® Memoria de Colores Oscuros</h1>
        <div class="timer">‚è∞ Tiempo: <span id="timer-colors">70</span>s</div>
        <div class="player-info">
            <div class="current-player">Turno de: <span id="current-player-colors"></span></div>
            <div class="scores" id="scores-colors"></div>
        </div>
        <div class="memory-grid" id="grid-colors"></div>
    </div>

    <!-- Memory Game 2: Animals -->
    <div id="memory-animals" class="screen">
        <div class="game-progress">Juego 2 de 6: Memoria de Animales</div>
        <h1>üêæ Memoria de Animales</h1>
        <div class="timer">‚è∞ Tiempo: <span id="timer-animals">70</span>s</div>
        <div class="player-info">
            <div class="current-player">Turno de: <span id="current-player-animals"></span></div>
            <div class="scores" id="scores-animals"></div>
        </div>
        <div class="memory-grid" id="grid-animals"></div>
    </div>

    <!-- Memory Game 3: Emotions -->
    <div id="memory-emotions" class="screen">
        <div class="game-progress">Juego 3 de 6: Memoria de Emociones</div>
        <h1>üòä Memoria de Emociones</h1>
        <div class="timer">‚è∞ Tiempo: <span id="timer-emotions">70</span>s</div>
        <div class="player-info">
            <div class="current-player">Turno de: <span id="current-player-emotions"></span></div>
            <div class="scores" id="scores-emotions"></div>
        </div>
        <div class="memory-grid" id="grid-emotions"></div>
    </div>

    <!-- Writing Game 1: Colors -->
    <div id="writing-colors" class="screen">
        <div class="game-progress">Juego 4 de 6: Escritura de Colores</div>
        <h1>‚úèÔ∏è Escribir Colores (Ingl√©s / Espa√±ol)</h1>
        <div class="timer">‚è∞ Tiempo: <span id="timer-write-colors">70</span>s</div>
        <div class="player-info">
            <div class="current-player">Turno de: <span id="current-player-write-colors"></span></div>
            <div class="scores" id="scores-write-colors"></div>
        </div>
        <div class="writing-display color" id="display-write-colors"></div>
        <div class="input-section">
            <input type="text" class="answer-input" id="input-write-colors" placeholder="Ejemplo: Dark red / Rojo oscuro">
            <br>
            <button class="submit-btn" onclick="checkWritingAnswer('colors')">‚úÖ Verificar Respuesta</button>
        </div>
        <div class="feedback" id="feedback-write-colors"></div>
    </div>

    <!-- Writing Game 2: Animals -->
    <div id="writing-animals" class="screen">
        <div class="game-progress">Juego 5 de 6: Escritura de Animales</div>
        <h1>ü¶ä Escribir Animales (Ingl√©s / Espa√±ol)</h1>
        <div class="timer">‚è∞ Tiempo: <span id="timer-write-animals">70</span>s</div>
        <div class="player-info">
            <div class="current-player">Turno de: <span id="current-player-write-animals"></span></div>
            <div class="scores" id="scores-write-animals"></div>
        </div>
        <div class="writing-display" id="display-write-animals"></div>
        <div class="input-section">
            <input type="text" class="answer-input" id="input-write-animals" placeholder="Ejemplo: Dog / Perro">
            <br>
            <button class="submit-btn" onclick="checkWritingAnswer('animals')">‚úÖ Verificar Respuesta</button>
        </div>
        <div class="feedback" id="feedback-write-animals"></div>
    </div>

    <!-- Writing Game 3: Emotions -->
    <div id="writing-emotions" class="screen">
        <div class="game-progress">Juego 6 de 6: Escritura de Emociones</div>
        <h1>üòç Escribir Emociones (Ingl√©s / Espa√±ol)</h1>
        <div class="timer">‚è∞ Tiempo: <span id="timer-write-emotions">70</span>s</div>
        <div class="player-info">
            <div class="current-player">Turno de: <span id="current-player-write-emotions"></span></div>
            <div class="scores" id="scores-write-emotions"></div>
        </div>
        <div class="writing-display" id="display-write-emotions"></div>
        <div class="input-section">
            <input type="text" class="answer-input" id="input-write-emotions" placeholder="Ejemplo: Happy / Feliz">
            <br>
            <button class="submit-btn" onclick="checkWritingAnswer('emotions')">‚úÖ Verificar Respuesta</button>
        </div>
        <div class="feedback" id="feedback-write-emotions"></div>
    </div>

    <!-- Final Results -->
    <div id="final-results" class="screen">
        <div class="results-container">
            <h1>üèÜ Resultados Finales</h1>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Participante</th>
                        <th>Puntos Totales</th>
                        <th>Errores Cometidos</th>
                        <th>Posici√≥n</th>
                    </tr>
                </thead>
                <tbody id="final-results-body">
                </tbody>
            </table>
            <button class="btn btn-start" onclick="resetGame()">üîÑ Jugar de Nuevo</button>
        </div>
    </div>

    <!-- Admin Login -->
    <div id="login-screen" class="login-screen">
        <!-- Dense Background Snowfall -->
        <div class="snowfall-container">
            <!-- Row 1 -->
            <div class="snow snow-large" style="left: 2%; animation-duration: 8s; animation-delay: 0s;"></div>
            <div class="snow snow-medium" style="left: 6%; animation-duration: 12s; animation-delay: 1s;"></div>
            <div class="snow snow-small" style="left: 10%; animation-duration: 15s; animation-delay: 0.5s;"></div>
            <div class="snow snow-tiny" style="left: 14%; animation-duration: 18s; animation-delay: 2s;"></div>
            <div class="snow snow-medium" style="left: 18%; animation-duration: 10s; animation-delay: 1.5s;"></div>
            <div class="snow snow-large" style="left: 22%; animation-duration: 14s; animation-delay: 0.8s;"></div>
            <div class="snow snow-small" style="left: 26%; animation-duration: 16s; animation-delay: 2.5s;"></div>
            <div class="snow snow-tiny" style="left: 30%; animation-duration: 20s; animation-delay: 1.2s;"></div>
            <div class="snow snow-medium" style="left: 34%; animation-duration: 11s; animation-delay: 3s;"></div>
            <div class="snow snow-large" style="left: 38%; animation-duration: 13s; animation-delay: 0.3s;"></div>
            <div class="snow snow-small" style="left: 42%; animation-duration: 17s; animation-delay: 2.2s;"></div>
            <div class="snow snow-tiny" style="left: 46%; animation-duration: 19s; animation-delay: 1.8s;"></div>
            <div class="snow snow-medium" style="left: 50%; animation-duration: 9s; animation-delay: 2.8s;"></div>
            <div class="snow snow-large" style="left: 54%; animation-duration: 12s; animation-delay: 0.7s;"></div>
            <div class="snow snow-small" style="left: 58%; animation-duration: 14s; animation-delay: 3.2s;"></div>
            <div class="snow snow-tiny" style="left: 62%; animation-duration: 21s; animation-delay: 1.3s;"></div>
            <div class="snow snow-medium" style="left: 66%; animation-duration: 15s; animation-delay: 2.7s;"></div>
            <div class="snow snow-large" style="left: 70%; animation-duration: 8s; animation-delay: 0.9s;"></div>
            <div class="snow snow-small" style="left: 74%; animation-duration: 16s; animation-delay: 3.5s;"></div>
            <div class="snow snow-tiny" style="left: 78%; animation-duration: 22s; animation-delay: 1.7s;"></div>
            <div class="snow snow-medium" style="left: 82%; animation-duration: 11s; animation-delay: 2.1s;"></div>
            <div class="snow snow-large" style="left: 86%; animation-duration: 13s; animation-delay: 0.4s;"></div>
            <div class="snow snow-small" style="left: 90%; animation-duration: 18s; animation-delay: 2.9s;"></div>
            <div class="snow snow-tiny" style="left: 94%; animation-duration: 24s; animation-delay: 1.1s;"></div>
            <div class="snow snow-medium" style="left: 98%; animation-duration: 10s; animation-delay: 3.6s;"></div>

            <!-- Row 2 - Offset positions for better coverage -->
            <div class="snow snow-small" style="left: 1%; animation-duration: 19s; animation-delay: 4s;"></div>
            <div class="snow snow-large" style="left: 5%; animation-duration: 9s; animation-delay: 0.6s;"></div>
            <div class="snow snow-tiny" style="left: 9%; animation-duration: 23s; animation-delay: 2.4s;"></div>
            <div class="snow snow-medium" style="left: 13%; animation-duration: 12s; animation-delay: 1.9s;"></div>
            <div class="snow snow-large" style="left: 17%; animation-duration: 7s; animation-delay: 3.1s;"></div>
            <div class="snow snow-small" style="left: 21%; animation-duration: 17s; animation-delay: 0.2s;"></div>
            <div class="snow snow-tiny" style="left: 25%; animation-duration: 25s; animation-delay: 2.6s;"></div>
            <div class="snow snow-medium" style="left: 29%; animation-duration: 14s; animation-delay: 1.4s;"></div>
            <div class="snow snow-large" style="left: 33%; animation-duration: 8s; animation-delay: 3.8s;"></div>
            <div class="snow snow-small" style="left: 37%; animation-duration: 20s; animation-delay: 0.1s;"></div>
            <div class="snow snow-tiny" style="left: 41%; animation-duration: 26s; animation-delay: 2.3s;"></div>
            <div class="snow snow-medium" style="left: 45%; animation-duration: 11s; animation-delay: 1.6s;"></div>
            <div class="snow snow-large" style="left: 49%; animation-duration: 6s; animation-delay: 3.3s;"></div>
            <div class="snow snow-small" style="left: 53%; animation-duration: 16s; animation-delay: 0.8s;"></div>
            <div class="snow snow-tiny" style="left: 57%; animation-duration: 27s; animation-delay: 2.7s;"></div>
            <div class="snow snow-medium" style="left: 61%; animation-duration: 13s; animation-delay: 1.0s;"></div>
            <div class="snow snow-large" style="left: 65%; animation-duration: 9s; animation-delay: 3.9s;"></div>
            <div class="snow snow-small" style="left: 69%; animation-duration: 21s; animation-delay: 0.5s;"></div>
            <div class="snow snow-tiny" style="left: 73%; animation-duration: 28s; animation-delay: 2.0s;"></div>
            <div class="snow snow-medium" style="left: 77%; animation-duration: 12s; animation-delay: 1.8s;"></div>
            <div class="snow snow-large" style="left: 81%; animation-duration: 7s; animation-delay: 3.4s;"></div>
            <div class="snow snow-small" style="left: 85%; animation-duration: 18s; animation-delay: 0.7s;"></div>
            <div class="snow snow-tiny" style="left: 89%; animation-duration: 29s; animation-delay: 2.8s;"></div>
            <div class="snow snow-medium" style="left: 93%; animation-duration: 15s; animation-delay: 1.3s;"></div>
            <div class="snow snow-large" style="left: 97%; animation-duration: 8s; animation-delay: 3.7s;"></div>

            <!-- Row 3 - Additional layer for maximum density -->
            <div class="snow snow-tiny" style="left: 3%; animation-duration: 30s; animation-delay: 4.2s;"></div>
            <div class="snow snow-small" style="left: 7%; animation-duration: 22s; animation-delay: 0.9s;"></div>
            <div class="snow snow-medium" style="left: 11%; animation-duration: 13s; animation-delay: 2.5s;"></div>
            <div class="snow snow-large" style="left: 15%; animation-duration: 6s; animation-delay: 1.7s;"></div>
            <div class="snow snow-tiny" style="left: 19%; animation-duration: 31s; animation-delay: 3.0s;"></div>
            <div class="snow snow-small" style="left: 23%; animation-duration: 19s; animation-delay: 0.4s;"></div>
            <div class="snow snow-medium" style="left: 27%; animation-duration: 14s; animation-delay: 2.1s;"></div>
            <div class="snow snow-large" style="left: 31%; animation-duration: 5s; animation-delay: 1.9s;"></div>
            <div class="snow snow-tiny" style="left: 35%; animation-duration: 32s; animation-delay: 3.5s;"></div>
            <div class="snow snow-small" style="left: 39%; animation-duration: 17s; animation-delay: 0.6s;"></div>
            <div class="snow snow-medium" style="left: 43%; animation-duration: 12s; animation-delay: 2.4s;"></div>
            <div class="snow snow-large" style="left: 47%; animation-duration: 7s; animation-delay: 1.1s;"></div>
            <div class="snow snow-tiny" style="left: 51%; animation-duration: 33s; animation-delay: 3.8s;"></div>
            <div class="snow snow-small" style="left: 55%; animation-duration: 20s; animation-delay: 0.3s;"></div>
            <div class="snow snow-medium" style="left: 59%; animation-duration: 11s; animation-delay: 2.6s;"></div>
            <div class="snow snow-large" style="left: 63%; animation-duration: 8s; animation-delay: 1.5s;"></div>
            <div class="snow snow-tiny" style="left: 67%; animation-duration: 34s; animation-delay: 3.1s;"></div>
            <div class="snow snow-small" style="left: 71%; animation-duration: 23s; animation-delay: 0.8s;"></div>
            <div class="snow snow-medium" style="left: 75%; animation-duration: 10s; animation-delay: 2.9s;"></div>
            <div class="snow snow-large" style="left: 79%; animation-duration: 9s; animation-delay: 1.2s;"></div>
            <div class="snow snow-tiny" style="left: 83%; animation-duration: 35s; animation-delay: 3.6s;"></div>
            <div class="snow snow-small" style="left: 87%; animation-duration: 24s; animation-delay: 0.1s;"></div>
            <div class="snow snow-medium" style="left: 91%; animation-duration: 13s; animation-delay: 2.7s;"></div>
            <div class="snow snow-large" style="left: 95%; animation-duration: 6s; animation-delay: 1.8s;"></div>
            <div class="snow snow-tiny" style="left: 99%; animation-duration: 36s; animation-delay: 4.0s;"></div>
        </div>
        
        <div class="login-box">
            <h1>üîê Login Administrador</h1>
            <div class="login-field">
                <label>Usuario:</label>
                <input type="text" id="admin-user">
            </div>
            <div class="login-field">
                <label>Contrase√±a:</label>
                <input type="password" id="admin-pass">
            </div>
            <button class="btn" onclick="adminLogin()">üöÄ Iniciar Sesi√≥n</button>
            <button class="btn" onclick="hideAdmin()">‚ùå Cancelar</button>
        </div>
    </div>

    <!-- Visual Tools Modal -->
    <div id="visual-tools-modal" class="visual-tools-modal">
        <div class="visual-tools-content">
            <h2>üîß Herramientas Visuales Avanzadas</h2>
            
            <!-- Game Selection -->
            <div class="visual-tools-section">
                <h4>üìã Seleccionar Juego:</h4>
                <select id="visual-game-select" class="admin-select">
                    <option value="">-- Selecciona un juego --</option>
                    <option value="memory-colors">üé® Memoria de Colores</option>
                    <option value="memory-animals">üêæ Memoria de Animales</option>
                    <option value="memory-emotions">üòä Memoria de Emociones</option>
                    <option value="writing-colors">‚úèÔ∏è Escritura de Colores</option>
                    <option value="writing-animals">ü¶ä Escritura de Animales</option>
                    <option value="writing-emotions">üòç Escritura de Emociones</option>
                </select>
            </div>

            <!-- Player Selection -->
            <div class="visual-tools-section">
                <h4>üë§ Seleccionar Jugador:</h4>
                <select id="visual-player-select" class="admin-select">
                    <option value="">-- Selecciona un jugador --</option>
                </select>
            </div>

            <!-- Incorrect Answer Selection -->
            <div class="visual-tools-section">
                <h4>‚ùå Respuesta Incorrecta a Mostrar:</h4>
                <select id="visual-answer-select" class="admin-select">
                    <option value="">-- Selecciona primero un juego --</option>
                </select>
            </div>

            <!-- Visual Effect Selection -->
            <div class="visual-tools-section">
                <h4>üé® Efecto Visual:</h4>
                <select id="visual-effect-select" class="admin-select">
                    <option value="hue-rotate">üåà Cambio de colores</option>
                    <option value="blur">üå´Ô∏è Desenfoque</option>
                    <option value="rotate">üîÑ Rotaci√≥n</option>
                    <option value="grayscale">‚ö´ Escala de grises</option>
                    <option value="shake">üì≥ Vibraci√≥n</option>
                    <option value="sepia">üü§ Efecto vintage</option>
                    <option value="contrast">‚ö° Alto contraste</option>
                </select>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="aplicarSimulacionAvanzada()" style="background: linear-gradient(45deg, #28a745, #20c997);">üöÄ Aplicar Simulaci√≥n</button>
                <button class="btn" onclick="cerrarHerramientasVisuales()" style="background: linear-gradient(45deg, #6c757d, #5a6268);">‚ùå Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-screen" class="screen">
        <div style="background: rgba(255,255,255,0.95); padding: 40px; border-radius: 20px; margin: 20px auto; max-width: 1000px;">
            <h2>üéÆ Panel de Administrador</h2>
            
            <!-- Secci√≥n Ver Respuestas -->
            <div style="background: rgba(255, 255, 255, 0.9); margin: 20px 0; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-left: 4px solid #4CAF50;">
                <h3>üìã Respuestas del Juego</h3>
                <button class="btn" onclick="mostrarRespuestasInteractivas()">Ver Todas las Respuestas</button>
                <div id="respuestas-interactivas" style="display: none; margin-top: 20px;">
                    <div style="margin: 20px 0; padding: 15px; background: rgba(248, 249, 250, 0.8); border-radius: 8px; border: 1px solid #dee2e6;">
                        <h4>üé® Memoria Colores</h4>
                        <div id="respuestas-colores-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;"></div>
                    </div>
                    <div style="margin: 20px 0; padding: 15px; background: rgba(248, 249, 250, 0.8); border-radius: 8px; border: 1px solid #dee2e6;">
                        <h4>üêæ Memoria Animales</h4>
                        <div id="respuestas-animales-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;"></div>
                    </div>
                    <div style="margin: 20px 0; padding: 15px; background: rgba(248, 249, 250, 0.8); border-radius: 8px; border: 1px solid #dee2e6;">
                        <h4>üòä Memoria Emociones</h4>
                        <div id="respuestas-emociones-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;"></div>
                    </div>
                    <div style="margin: 20px 0; padding: 15px; background: rgba(248, 249, 250, 0.8); border-radius: 8px; border: 1px solid #dee2e6;">
                        <h4>‚úèÔ∏è Escritura Colores</h4>
                        <div id="respuestas-escritura-colores-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;"></div>
                    </div>
                    <div style="margin: 20px 0; padding: 15px; background: rgba(248, 249, 250, 0.8); border-radius: 8px; border: 1px solid #dee2e6;">
                        <h4>ü¶ä Escritura Animales</h4>
                        <div id="respuestas-escritura-animales-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;"></div>
                    </div>
                    <div style="margin: 20px 0; padding: 15px; background: rgba(248, 249, 250, 0.8); border-radius: 8px; border: 1px solid #dee2e6;">
                        <h4>üòç Escritura Emociones</h4>
                        <div id="respuestas-escritura-emociones-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;"></div>
                    </div>
                    <button class="btn" onclick="ocultarRespuestas()" style="background: linear-gradient(45deg, #6c757d, #5a6268);">Ocultar Respuestas</button>
                </div>
            </div>

            <!-- Secci√≥n Cambiar Juego -->
            <div style="background: rgba(255, 255, 255, 0.9); margin: 20px 0; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-left: 4px solid #4CAF50;">
                <h3>üéØ Navegaci√≥n de Juegos</h3>
                <select id="cambiar-juego-select" style="padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; margin: 5px; background: white; min-width: 300px;">
                    <option value="">Seleccionar juego</option>
                    <option value="memory-colors">üé® Memoria Colores</option>
                    <option value="memory-animals">üêæ Memoria Animales</option>
                    <option value="memory-emotions">üòä Memoria Emociones</option>
                    <option value="writing-colors">‚úèÔ∏è Escritura Colores</option>
                    <option value="writing-animals">ü¶ä Escritura Animales</option>
                    <option value="writing-emotions">üòç Escritura Emociones</option>
                    <option value="final-results">üèÜ Resultados Finales</option>
                </select>
                <button class="btn" onclick="irAJuegoSeleccionado()">Ir al Juego Seleccionado</button>
            </div>

            <!-- Secci√≥n Gesti√≥n de Puntos -->
            <div style="background: rgba(255, 255, 255, 0.9); margin: 20px 0; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-left: 4px solid #4CAF50;">
                <h3>‚ö° Gesti√≥n de Puntos</h3>
                
                <!-- Resetear todos los puntos -->
                <div style="margin-bottom: 25px;">
                    <button class="btn" onclick="resetearPuntos()" style="background: linear-gradient(45deg, #dc3545, #c82333);">üîÑ Resetear Todos los Puntos</button>
                </div>

                <!-- Modificar puntos individuales -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-top: 0; color: #495057;">‚úèÔ∏è Modificar Puntos de Jugador</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #495057;">Seleccionar Jugador:</label>
                            <select id="puntos-jugador-select" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; background: white;">
                                <option value="">-- Selecciona un jugador --</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #495057;">Acci√≥n:</label>
                            <select id="puntos-accion-select" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; background: white;">
                                <option value="set">üìù Establecer puntos exactos</option>
                                <option value="add">‚ûï Agregar puntos</option>
                                <option value="subtract">‚ûñ Quitar puntos</option>
                            </select>
                        </div>
                    </div>

                    <div style="display: flex; align-items: end; gap: 10px;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #495057;">Cantidad de Puntos:</label>
                            <input type="number" id="puntos-cantidad" placeholder="0" min="0" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; background: white;">
                        </div>
                        <button class="btn" onclick="aplicarCambioPuntos()" style="background: linear-gradient(45deg, #28a745, #20c997);">‚úÖ Aplicar</button>
                    </div>

                    <div id="puntos-preview" style="margin-top: 10px; padding: 10px; background: #e9ecef; border-radius: 6px; font-size: 14px; color: #6c757d; display: none;">
                        <!-- Preview will be shown here -->
                    </div>
                </div>
            </div>

            <!-- Secci√≥n Auto Ganado -->
            <div style="background: rgba(255, 255, 255, 0.9); margin: 20px 0; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-left: 4px solid #4CAF50;">
                <h3>üèÜ Auto Ganado</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Selecciona un jugador para que gane autom√°ticamente el juego</p>
                <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-top: 10px;">
                    <select id="auto-ganado-select" style="padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; margin: 5px; background: white; min-width: 250px;">
                        <option value="">-- Selecciona un jugador --</option>
                    </select>
                    <button class="btn" onclick="aplicarAutoGanado()" style="background: linear-gradient(45deg, #ffc107, #e0a800); color: #212529;">üëë Aplicar Auto Ganado</button>
                </div>
                <p style="font-size: 12px; color: #666; font-style: italic; margin: 10px 0;">* Esta funci√≥n otorgar√° puntos suficientes para garantizar la victoria del jugador seleccionado</p>
            </div>

 rgba(255, 255, 255, 0.9); margin: 20px 0; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-left: 4px solid #4CAF50;">
                <h3>üîß Herramientas Visuales</h3>
                <button class="btn" onclick="abrirHerramientasVisuales()" style="background: linear-gradient(45deg, #ffc107, #e0a800); color: #212529;">üé® Configurar Simulaci√≥n Avanzada</button>
                <p style="font-size: 12px; color: #666; font-style: italic; margin: 10px 0;">* Herramientas para simular respuestas incorrectas con efectos visuales personalizados</p>
            </div>

            <button class="btn" onclick="volverAlMenu()" style="background: linear-gradient(45deg, #6c757d, #5a6268);">‚¨ÖÔ∏è Volver al Juego</button>
        </div>
    </div>

    <!-- Admin Button -->
    <button class="admin-btn" onclick="showAdmin()">üë®‚Äçüíº Admin</button>

    <script>
        // Game data
        let participants = [];
        let scores = [];
        let errors = [];
        let currentPlayer = 0;
        let currentGame = 0;
        let timer = 70;
        let timerInterval;
        let flippedCards = [];
        let matchedPairs = 0;
        let currentAnswer = '';
        let previousScreen = 'rules-screen'; // Track previous screen for admin panel
        
        // Multiplayer variables
        let isMultiplayer = false;
        let isHost = false;
        let currentRoom = null;
        let roomCode = '';
        let multiplayerPlayers = [];
        let simulatedRooms = [
            { code: 'GAME01', name: 'Sala de Amigos', players: 3, maxPlayers: 6, host: 'Mar√≠a' },
            { code: 'FUN123', name: 'Diversi√≥n Total', players: 2, maxPlayers: 4, host: 'Carlos' },
            { code: 'PLAY99', name: 'Juego R√°pido', players: 1, maxPlayers: 8, host: 'Ana' }
        ];

        // Game data arrays
        const colors = [
            { spanish: 'Rojo oscuro', english: 'Dark red', class: 'color-rojo-oscuro' },
            { spanish: 'Azul oscuro', english: 'Dark blue', class: 'color-azul-oscuro' },
            { spanish: 'Verde oscuro', english: 'Dark green', class: 'color-verde-oscuro' },
            { spanish: 'Amarillo oscuro', english: 'Dark yellow', class: 'color-amarillo-oscuro' },
            { spanish: 'Morado oscuro', english: 'Dark purple', class: 'color-morado-oscuro' },
            { spanish: 'Gris oscuro', english: 'Dark gray', class: 'color-gris-oscuro' }
        ];

        const animals = [
            { spanish: 'Perro', english: 'Dog', emoji: 'üê∂' },
            { spanish: 'Gato', english: 'Cat', emoji: 'üê±' },
            { spanish: 'Rat√≥n', english: 'Mouse', emoji: 'üê≠' },
            { spanish: 'H√°mster', english: 'Hamster', emoji: 'üêπ' },
            { spanish: 'Conejo', english: 'Rabbit', emoji: 'üê∞' },
            { spanish: 'Zorro', english: 'Fox', emoji: 'ü¶ä' }
        ];

        const emotions = [
            { spanish: 'Feliz', english: 'Happy', emoji: 'üòÄ' },
            { spanish: 'Triste', english: 'Sad', emoji: 'üò¢' },
            { spanish: 'Enojado', english: 'Angry', emoji: 'üò°' },
            { spanish: 'Sorprendido', english: 'Surprised', emoji: 'üò±' },
            { spanish: 'Dormido', english: 'Sleepy', emoji: 'üò¥' },
            { spanish: 'Enamorado', english: 'In love', emoji: 'üòç' }
        ];

        const games = [
            'memory-colors', 'memory-animals', 'memory-emotions',
            'writing-colors', 'writing-animals', 'writing-emotions'
        ];

        // Utility functions
        function showScreen(screenId) {
            // Store previous screen before switching (exclude admin screens)
            if (!screenId.includes('admin') && !screenId.includes('login')) {
                const currentActive = document.querySelector('.screen.active');
                if (currentActive && !currentActive.id.includes('admin') && !currentActive.id.includes('login')) {
                    previousScreen = currentActive.id;
                }
            }
            
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function showSetup() {
            showScreen('setup-screen');
        }

        function showAdmin() {
            document.getElementById('login-screen').style.display = 'flex';
        }
        
        // Multiplayer Functions
        function mostrarOpcionesMultijugador() {
            showScreen('multiplayer-screen');
        }

        function mostrarCrearSala() {
            showScreen('create-room-screen');
        }

        function mostrarUnirseSala() {
            showScreen('join-room-screen');
            buscarSalas();
        }

        function hideAdmin() {
            document.getElementById('login-screen').style.display = 'none';
        }

        function adminLogin() {
            const user = document.getElementById('admin-user').value;
            const pass = document.getElementById('admin-pass').value;
            
            if (user === 'Cheft_gamer68' && pass === 'nixbox top') {
                hideAdmin();
                showScreen('admin-screen');
                // Actualizar listas de jugadores
                actualizarListaAutoGanado();
                actualizarListaPuntosJugadores();
                document.getElementById('admin-user').value = '';
                document.getElementById('admin-pass').value = '';
            } else {
                alert('Credenciales incorrectas');
            }
        }

        // Points Management Functions
        function actualizarListaPuntosJugadores() {
            const puntosJugadorSelect = document.getElementById('puntos-jugador-select');
            puntosJugadorSelect.innerHTML = '<option value="">-- Selecciona un jugador --</option>';
            
            participants.forEach((participant, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${participant} (${scores[index]} puntos)`;
                puntosJugadorSelect.appendChild(option);
            });
        }

        function aplicarCambioPuntos() {
            const jugadorIndex = document.getElementById('puntos-jugador-select').value;
            const accion = document.getElementById('puntos-accion-select').value;
            const cantidad = parseInt(document.getElementById('puntos-cantidad').value);

            if (jugadorIndex === '') {
                alert('Por favor selecciona un jugador');
                return;
            }

            if (isNaN(cantidad) || cantidad < 0) {
                alert('Por favor ingresa una cantidad v√°lida (n√∫mero mayor o igual a 0)');
                return;
            }

            const playerIndex = parseInt(jugadorIndex);
            const playerName = participants[playerIndex];
            const puntosActuales = scores[playerIndex];
            let puntosNuevos;

            switch(accion) {
                case 'set':
                    puntosNuevos = cantidad;
                    break;
                case 'add':
                    puntosNuevos = puntosActuales + cantidad;
                    break;
                case 'subtract':
                    puntosNuevos = Math.max(0, puntosActuales - cantidad); // No permitir puntos negativos
                    break;
                default:
                    alert('Acci√≥n no v√°lida');
                    return;
            }

            // Aplicar el cambio
            scores[playerIndex] = puntosNuevos;

            // Preparar mensaje de confirmaci√≥n
            const accionTexto = {
                'set': `establecidos en ${cantidad}`,
                'add': `incrementados en ${cantidad} (${puntosActuales} + ${cantidad})`,
                'subtract': `reducidos en ${cantidad} (${puntosActuales} - ${cantidad})`
            };

            const confirmacionInfo = `‚úÖ PUNTOS MODIFICADOS ‚úÖ

üë§ Jugador: ${playerName}
üìä Puntos Anteriores: ${puntosActuales}
‚ö° Acci√≥n: Puntos ${accionTexto[accion]}
üéØ Puntos Nuevos: ${puntosNuevos}

Los cambios se han aplicado correctamente.`;

            alert(confirmacionInfo);

            // Actualizar todas las interfaces
            actualizarTodasLasTablasDePuntos();
            actualizarListaPuntosJugadores();
            actualizarListaAutoGanado();

            // Limpiar campos
            document.getElementById('puntos-cantidad').value = '';
            document.getElementById('puntos-preview').style.display = 'none';
        }

        // Preview functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for preview when DOM is ready
            setTimeout(() => {
                const jugadorSelect = document.getElementById('puntos-jugador-select');
                const accionSelect = document.getElementById('puntos-accion-select');
                const cantidadInput = document.getElementById('puntos-cantidad');

                if (jugadorSelect && accionSelect && cantidadInput) {
                    const updatePreview = () => mostrarPreviewPuntos();
                    jugadorSelect.addEventListener('change', updatePreview);
                    accionSelect.addEventListener('change', updatePreview);
                    cantidadInput.addEventListener('input', updatePreview);
                }
            }, 100);
        });

        function mostrarPreviewPuntos() {
            const jugadorIndex = document.getElementById('puntos-jugador-select').value;
            const accion = document.getElementById('puntos-accion-select').value;
            const cantidad = parseInt(document.getElementById('puntos-cantidad').value);
            const previewDiv = document.getElementById('puntos-preview');

            if (jugadorIndex === '' || isNaN(cantidad)) {
                previewDiv.style.display = 'none';
                return;
            }

            const playerIndex = parseInt(jugadorIndex);
            const playerName = participants[playerIndex];
            const puntosActuales = scores[playerIndex];
            let puntosNuevos;
            let accionTexto;

            switch(accion) {
                case 'set':
                    puntosNuevos = cantidad;
                    accionTexto = `üìù Establecer ${cantidad} puntos`;
                    break;
                case 'add':
                    puntosNuevos = puntosActuales + cantidad;
                    accionTexto = `‚ûï Agregar ${cantidad} puntos`;
                    break;
                case 'subtract':
                    puntosNuevos = Math.max(0, puntosActuales - cantidad);
                    accionTexto = `‚ûñ Quitar ${cantidad} puntos`;
                    break;
            }

            previewDiv.innerHTML = `
                <strong>üìã Vista Previa:</strong><br>
                üë§ ${playerName}: ${puntosActuales} ‚Üí ${puntosNuevos} puntos<br>
                üîß ${accionTexto}
            `;
            previewDiv.style.display = 'block';
        }

        // Auto Ganado Functions
        function actualizarListaAutoGanado() {
            const autoGanadoSelect = document.getElementById('auto-ganado-select');
            autoGanadoSelect.innerHTML = '<option value="">-- Selecciona un jugador --</option>';
            
            participants.forEach((participant, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${index + 1}. ${participant}`;
                autoGanadoSelect.appendChild(option);
            });
        }

        function aplicarAutoGanado() {
            const selectedIndex = document.getElementById('auto-ganado-select').value;
            
            if (selectedIndex === '') {
                alert('Por favor selecciona un jugador');
                return;
            }

            if (participants.length === 0) {
                alert('No hay participantes en el juego');
                return;
            }

            const playerIndex = parseInt(selectedIndex);
            const playerName = participants[playerIndex];
            
            // Calcular puntos necesarios para ganar
            const maxPuntos = Math.max(...scores);
            const puntosParaGanar = maxPuntos + 10; // Asegurar victoria con margen
            
            // Aplicar puntos al jugador seleccionado
            scores[playerIndex] = puntosParaGanar;
            
            // Actualizar todas las tablas de puntuaci√≥n
            actualizarTodasLasTablasDePuntos();
            
            // Mostrar confirmaci√≥n detallada
            const confirmacionInfo = `üèÜ AUTO GANADO APLICADO üèÜ

üë§ Jugador Seleccionado: ${playerName}
üéØ Puntos Anteriores: ${scores[playerIndex] - puntosParaGanar}
‚ö° Puntos Nuevos: ${puntosParaGanar}
üìä Puntos M√°ximos Anteriores: ${maxPuntos}

‚úÖ ${playerName} ahora tiene la puntuaci√≥n m√°s alta y ganar√° el juego.

‚ö†Ô∏è Los cambios se reflejar√°n en todas las pantallas de puntuaci√≥n.`;

            alert(confirmacionInfo);
            
            // Efecto visual celebratorio
            aplicarEfectoCelebracion();
        }

        function aplicarEfectoCelebracion() {
            // Efecto de confeti visual
            document.body.style.filter = 'hue-rotate(45deg) brightness(1.2)';
            document.body.style.animation = 'celebrate 2s ease-in-out';
            
            // Agregar animaci√≥n de celebraci√≥n si no existe
            if (!document.getElementById('celebrate-animation')) {
                const style = document.createElement('style');
                style.id = 'celebrate-animation';
                style.textContent = `
                    @keyframes celebrate {
                        0%, 100% { transform: scale(1) rotate(0deg); }
                        25% { transform: scale(1.05) rotate(2deg); }
                        50% { transform: scale(1.1) rotate(-1deg); }
                        75% { transform: scale(1.05) rotate(1deg); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            setTimeout(() => {
                document.body.style.filter = 'none';
                document.body.style.animation = '';
            }, 2000);
        }

        // Visual Tools Functions
        function abrirHerramientasVisuales() {
            // Update player options
            const playerSelect = document.getElementById('visual-player-select');
            playerSelect.innerHTML = '<option value="">-- Selecciona un jugador --</option>';
            
            participants.forEach((participant, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${index + 1}. ${participant}`;
                playerSelect.appendChild(option);
            });

            document.getElementById('visual-tools-modal').style.display = 'flex';
        }

        function cerrarHerramientasVisuales() {
            document.getElementById('visual-tools-modal').style.display = 'none';
        }

        // Update answer options based on selected game
        document.getElementById('visual-game-select').addEventListener('change', function() {
            const gameType = this.value;
            const answerSelect = document.getElementById('visual-answer-select');
            answerSelect.innerHTML = '<option value="">-- Selecciona una respuesta --</option>';

            if (gameType.includes('colors')) {
                colors.forEach(color => {
                    const option = document.createElement('option');
                    option.value = `${color.english} / ${color.spanish}`;
                    option.textContent = `${color.spanish} ‚Üí ${color.english} / ${color.spanish}`;
                    answerSelect.appendChild(option);
                });
            } else if (gameType.includes('animals')) {
                animals.forEach(animal => {
                    const option = document.createElement('option');
                    option.value = `${animal.english} / ${animal.spanish}`;
                    option.textContent = `${animal.emoji} ‚Üí ${animal.english} / ${animal.spanish}`;
                    answerSelect.appendChild(option);
                });
            } else if (gameType.includes('emotions')) {
                emotions.forEach(emotion => {
                    const option = document.createElement('option');
                    option.value = `${emotion.english} / ${emotion.spanish}`;
                    option.textContent = `${emotion.emoji} ‚Üí ${emotion.english} / ${emotion.spanish}`;
                    answerSelect.appendChild(option);
                });
            }
        });

        function aplicarSimulacionAvanzada() {
            const gameSelect = document.getElementById('visual-game-select').value;
            const playerSelect = document.getElementById('visual-player-select').value;
            const answerSelect = document.getElementById('visual-answer-select').value;
            const effectSelect = document.getElementById('visual-effect-select').value;

            if (!gameSelect || playerSelect === '' || !answerSelect || !effectSelect) {
                alert('Por favor completa todos los campos');
                return;
            }

            const playerName = participants[parseInt(playerSelect)];
            const gameNames = {
                'memory-colors': 'üé® Memoria de Colores',
                'memory-animals': 'üêæ Memoria de Animales', 
                'memory-emotions': 'üòä Memoria de Emociones',
                'writing-colors': '‚úèÔ∏è Escritura de Colores',
                'writing-animals': 'ü¶ä Escritura de Animales',
                'writing-emotions': 'üòç Escritura de Emociones'
            };

            const effectNames = {
                'hue-rotate': 'üåà Cambio de colores',
                'blur': 'üå´Ô∏è Desenfoque',
                'rotate': 'üîÑ Rotaci√≥n',
                'grayscale': '‚ö´ Escala de grises',
                'shake': 'üì≥ Vibraci√≥n',
                'sepia': 'üü§ Efecto vintage',
                'contrast': '‚ö° Alto contraste'
            };

            // Apply visual effect
            aplicarEfectoVisual(effectSelect);

            // Show detailed simulation info
            const simulationInfo = `üéÆ SIMULACI√ìN AVANZADA APLICADA üéÆ

üìã Configuraci√≥n:
‚Ä¢ Juego: ${gameNames[gameSelect]}
‚Ä¢ Jugador: ${playerName}
‚Ä¢ Respuesta Incorrecta: ${answerSelect}
‚Ä¢ Efecto Visual: ${effectNames[effectSelect]}

‚úÖ Simulaci√≥n ejecutada correctamente
‚ö†Ô∏è Esta es una simulaci√≥n que no afecta el juego real`;

            alert(simulationInfo);
            cerrarHerramientasVisuales();
        }

        function aplicarEfectoVisual(effect) {
            const efectos = {
                'hue-rotate': () => {
                    document.body.style.filter = 'hue-rotate(180deg)';
                    setTimeout(() => document.body.style.filter = 'none', 3000);
                },
                'blur': () => {
                    document.body.style.filter = 'blur(2px)';
                    setTimeout(() => document.body.style.filter = 'none', 2000);
                },
                'rotate': () => {
                    document.body.style.transform = 'rotate(5deg)';
                    setTimeout(() => document.body.style.transform = 'none', 2500);
                },
                'grayscale': () => {
                    document.body.style.filter = 'grayscale(100%)';
                    setTimeout(() => document.body.style.filter = 'none', 3000);
                },
                'shake': () => {
                    document.body.style.animation = 'shake 0.5s ease-in-out 0s 3';
                    if (!document.getElementById('shake-animation')) {
                        const style = document.createElement('style');
                        style.id = 'shake-animation';
                        style.textContent = '@keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }';
                        document.head.appendChild(style);
                    }
                    setTimeout(() => document.body.style.animation = '', 1500);
                },
                'sepia': () => {
                    document.body.style.filter = 'sepia(100%)';
                    setTimeout(() => document.body.style.filter = 'none', 3000);
                },
                'contrast': () => {
                    document.body.style.filter = 'contrast(200%) brightness(150%)';
                    setTimeout(() => document.body.style.filter = 'none', 2500);
                }
            };

            if (efectos[effect]) {
                efectos[effect]();
            }
        }

        // Admin Panel Functions
        function mostrarRespuestasInteractivas() {
            const container = document.getElementById('respuestas-interactivas');
            container.style.display = 'block';
            
            // Respuestas para Memoria de Colores
            const coloresGrid = document.getElementById('respuestas-colores-grid');
            coloresGrid.innerHTML = '';
            colors.forEach(color => {
                const item = document.createElement('div');
                item.style.cssText = 'background: white; padding: 10px; border-radius: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; transition: all 0.3s ease;';
                item.style.backgroundColor = getColorFromClass(color.class);
                item.style.color = 'white';
                item.style.textShadow = '1px 1px 2px rgba(0,0,0,0.8)';
                item.textContent = `${color.spanish} = ${color.english}`;
                coloresGrid.appendChild(item);
            });
            
            // Respuestas para Memoria de Animales
            const animalesGrid = document.getElementById('respuestas-animales-grid');
            animalesGrid.innerHTML = '';
            animals.forEach(animal => {
                const item = document.createElement('div');
                item.style.cssText = 'background: white; padding: 10px; border-radius: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; transition: all 0.3s ease;';
                item.innerHTML = `${animal.emoji} = ${animal.english} / ${animal.spanish}`;
                animalesGrid.appendChild(item);
            });
            
            // Respuestas para Memoria de Emociones
            const emocionesGrid = document.getElementById('respuestas-emociones-grid');
            emocionesGrid.innerHTML = '';
            emotions.forEach(emotion => {
                const item = document.createElement('div');
                item.style.cssText = 'background: white; padding: 10px; border-radius: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; transition: all 0.3s ease;';
                item.innerHTML = `${emotion.emoji} = ${emotion.english} / ${emotion.spanish}`;
                emocionesGrid.appendChild(item);
            });

            // Respuestas para Escritura de Colores
            const escrituraColoresGrid = document.getElementById('respuestas-escritura-colores-grid');
            escrituraColoresGrid.innerHTML = '';
            colors.forEach(color => {
                const item = document.createElement('div');
                item.style.cssText = 'background: white; padding: 10px; border-radius: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; transition: all 0.3s ease;';
                item.style.backgroundColor = getColorFromClass(color.class);
                item.style.color = 'white';
                item.style.textShadow = '1px 1px 2px rgba(0,0,0,0.8)';
                item.textContent = `${color.english} / ${color.spanish}`;
                escrituraColoresGrid.appendChild(item);
            });

            // Respuestas para Escritura de Animales
            const escrituraAnimalesGrid = document.getElementById('respuestas-escritura-animales-grid');
            escrituraAnimalesGrid.innerHTML = '';
            animals.forEach(animal => {
                const item = document.createElement('div');
                item.style.cssText = 'background: white; padding: 10px; border-radius: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; transition: all 0.3s ease;';
                item.innerHTML = `${animal.emoji} ‚Üí ${animal.english} / ${animal.spanish}`;
                escrituraAnimalesGrid.appendChild(item);
            });

            // Respuestas para Escritura de Emociones
            const escrituraEmocionesGrid = document.getElementById('respuestas-escritura-emociones-grid');
            escrituraEmocionesGrid.innerHTML = '';
            emotions.forEach(emotion => {
                const item = document.createElement('div');
                item.style.cssText = 'background: white; padding: 10px; border-radius: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; transition: all 0.3s ease;';
                item.innerHTML = `${emotion.emoji} ‚Üí ${emotion.english} / ${emotion.spanish}`;
                escrituraEmocionesGrid.appendChild(item);
            });
        }

        function getColorFromClass(className) {
            const colorMap = {
                'color-rojo-oscuro': 'darkred',
                'color-azul-oscuro': 'darkblue',
                'color-verde-oscuro': 'darkgreen',
                'color-amarillo-oscuro': '#B8860B',
                'color-morado-oscuro': 'darkmagenta',
                'color-gris-oscuro': 'dimgray'
            };
            return colorMap[className] || '#333';
        }

        function ocultarRespuestas() {
            document.getElementById('respuestas-interactivas').style.display = 'none';
        }

        function irAJuegoSeleccionado() {
            const selected = document.getElementById('cambiar-juego-select').value;
            if (selected) {
                // Clear any existing timers
                clearInterval(timerInterval);
                
                // Show the selected screen
                showScreen(selected);
                
                // Reset game state and initialize properly
                if (participants.length > 0) {
                    switch(selected) {
                        case 'memory-colors':
                            currentGame = 0;
                            currentPlayer = 0;
                            flippedCards = [];
                            matchedPairs = 0;
                            startMemoryGame(0);
                            break;
                        case 'memory-animals':
                            currentGame = 1;
                            currentPlayer = 0;
                            flippedCards = [];
                            matchedPairs = 0;
                            startMemoryGame(1);
                            break;
                        case 'memory-emotions':
                            currentGame = 2;
                            currentPlayer = 0;
                            flippedCards = [];
                            matchedPairs = 0;
                            startMemoryGame(2);
                            break;
                        case 'writing-colors':
                            currentGame = 3;
                            currentPlayer = 0;
                            currentAnswer = '';
                            startWritingGame(0);
                            break;
                        case 'writing-animals':
                            currentGame = 4;
                            currentPlayer = 0;
                            currentAnswer = '';
                            startWritingGame(1);
                            break;
                        case 'writing-emotions':
                            currentGame = 5;
                            currentPlayer = 0;
                            currentAnswer = '';
                            startWritingGame(2);
                            break;
                        case 'final-results':
                            showFinalResults();
                            break;
                    }
                } else {
                    alert('Primero debes agregar participantes para jugar');
                }
            } else {
                alert('Por favor selecciona un juego');
            }
        }

        function resetearPuntos() {
            if (participants.length > 0) {
                if (confirm('¬øEst√°s seguro de que quieres resetear todos los puntos?')) {
                    scores.fill(0);
                    errors.fill(0);
                    alert('Puntos y errores reseteados correctamente');
                    actualizarTodasLasTablasDePuntos();
                }
            } else {
                alert('No hay participantes para resetear puntos');
            }
        }

        function cambiarPuntos() {
            // Esta funci√≥n se mantiene para compatibilidad pero ya no se usa
            // La nueva funcionalidad est√° en aplicarCambioPuntos()
            alert('Esta funci√≥n ha sido reemplazada. Usa el nuevo sistema de gesti√≥n de puntos.');
        }

        function volverAlMenu() {
            // Return to the previous screen instead of rules
            showScreen(previousScreen);
        }

        function actualizarTodasLasTablasDePuntos() {
            // Update all score displays that are currently visible
            const gameTypes = ['colors', 'animals', 'emotions', 'write-colors', 'write-animals', 'write-emotions'];
            gameTypes.forEach(type => {
                const scoreContainer = document.getElementById(`scores-${type}`);
                if (scoreContainer) {
                    updateScores(type);
                }
            });
        }

        // Participant management
        function addParticipant() {
            const nameInput = document.getElementById('participant-name');
            const name = nameInput.value.trim();
            
            if (name && participants.length < 10) {
                participants.push(name);
                scores.push(0);
                errors.push(0);
                nameInput.value = '';
                updateParticipantsList();
                
                document.getElementById('start-roulette-btn').disabled = participants.length === 0;
            } else if (participants.length >= 10) {
                alert('M√°ximo 10 participantes permitidos.');
            }
        }

        function updateParticipantsList() {
            const container = document.getElementById('participants-container');
            if (participants.length === 0) {
                container.innerHTML = '<p>No hay participantes agregados</p>';
            } else {
                container.innerHTML = participants.map((name, index) => 
                    `<div class="participant-item">${index + 1}. ${name}</div>`
                ).join('');
            }
        }

        // Roulette functions
        function startRoulette() {
            if (participants.length === 0) {
                alert('Agrega al menos un participante.');
                return;
            }
            showScreen('roulette-screen');
            createRoulette();
        }

        function createRoulette() {
            const svg = document.getElementById('roulette-svg');
            svg.innerHTML = '';
            
            const anglePerSegment = 360 / participants.length;
            
            participants.forEach((participant, index) => {
                const startAngle = index * anglePerSegment;
                const endAngle = (index + 1) * anglePerSegment;
                
                const x1 = 150 + 150 * Math.cos(startAngle * Math.PI / 180);
                const y1 = 150 + 150 * Math.sin(startAngle * Math.PI / 180);
                const x2 = 150 + 150 * Math.cos(endAngle * Math.PI / 180);
                const y2 = 150 + 150 * Math.sin(endAngle * Math.PI / 180);
                
                const largeArc = anglePerSegment > 180 ? 1 : 0;
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', `M 150 150 L ${x1} ${y1} A 150 150 0 ${largeArc} 1 ${x2} ${y2} Z`);
                path.setAttribute('fill', `hsl(${index * anglePerSegment}, 70%, 60%)`);
                svg.appendChild(path);
                
                const textAngle = (startAngle + endAngle) / 2;
                const textX = 150 + 80 * Math.cos(textAngle * Math.PI / 180);
                const textY = 150 + 80 * Math.sin(textAngle * Math.PI / 180);
                
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', textX);
                text.setAttribute('y', textY);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('dominant-baseline', 'middle');
                text.setAttribute('fill', 'white');
                text.setAttribute('font-size', '14');
                text.setAttribute('font-weight', 'bold');
                text.textContent = participant;
                svg.appendChild(text);
            });
        }

        function spinRoulette() {
            const roulette = document.getElementById('roulette');
            const spins = Math.random() * 360 + 1800; // 5+ full rotations
            
            roulette.style.transform = `rotate(${spins}deg)`;
            
            setTimeout(() => {
                const finalAngle = spins % 360;
                const segmentAngle = 360 / participants.length;
                const winnerIndex = Math.floor((360 - finalAngle) / segmentAngle) % participants.length;
                
                currentPlayer = winnerIndex;
                
                document.getElementById('roulette-result').innerHTML = 
                    `<h2 style="color: #333; background: rgba(255,255,255,0.9); padding: 20px; border-radius: 15px; margin: 20px auto; display: inline-block;">¬°${participants[winnerIndex]} comenzar√° el juego!</h2>`;
                
                setTimeout(() => startGame(0), 3000);
            }, 3000);
        }

        // Game management
        function startGame(gameIndex) {
            currentGame = gameIndex;
            showScreen(games[gameIndex]);
            
            if (gameIndex < 3) {
                startMemoryGame(gameIndex);
            } else {
                startWritingGame(gameIndex - 3);
            }
        }

        function nextPlayer() {
            currentPlayer = (currentPlayer + 1) % participants.length;
        }

        function nextGame() {
            currentGame++;
            if (currentGame >= games.length) {
                showFinalResults();
            } else {
                currentPlayer = 0; // Reset to first player for new game
                startGame(currentGame);
            }
        }

        // Timer functions
        function startTimer(gameType) {
            timer = 70;
            const timerElement = document.getElementById(`timer-${gameType}`);
            timerElement.textContent = timer;
            
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timer--;
                timerElement.textContent = timer;
                
                if (timer <= 0) {
                    clearInterval(timerInterval);
                    handleTimeUp();
                }
            }, 1000);
        }

        function handleTimeUp() {
            if (currentGame < 3) {
                // Memory game - move to next player or next game
                nextPlayer();
                if (currentPlayer === 0) {
                    nextGame();
                } else {
                    startGame(currentGame);
                }
            } else {
                // Writing game - show incorrect and move to next
                showIncorrectAnswer();
                setTimeout(() => {
                    nextPlayer();
                    if (currentPlayer === 0) {
                        nextGame();
                    } else {
                        startGame(currentGame);
                    }
                }, 2000);
            }
        }

        // Memory game functions
        function startMemoryGame(gameIndex) {
            const gameTypes = ['colors', 'animals', 'emotions'];
            const gameType = gameTypes[gameIndex];
            
            updatePlayerInfo(gameType);
            createMemoryGrid(gameType);
            startTimer(gameType);
            
            flippedCards = [];
            matchedPairs = 0;
        }

        function createMemoryGrid(gameType) {
            const grid = document.getElementById(`grid-${gameType}`);
            grid.innerHTML = '';
            
            let gameData;
            if (gameType === 'colors') gameData = colors;
            else if (gameType === 'animals') gameData = animals;
            else if (gameType === 'emotions') gameData = emotions;
            
            // Create pairs
            const cards = [...gameData, ...gameData];
            shuffleArray(cards);
            
            cards.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = `memory-card ${gameType === 'colors' ? '' : gameType.slice(0, -1)}`;
                card.dataset.index = index;
                card.dataset.value = gameType === 'colors' ? item.spanish : (gameType === 'animals' ? item.emoji : item.emoji);
                
                if (gameType === 'colors') {
                    card.dataset.class = item.class;
                }
                
                card.addEventListener('click', () => flipCard(card, gameType));
                grid.appendChild(card);
            });
        }

        function flipCard(card, gameType) {
            if (flippedCards.length >= 2 || card.classList.contains('flipped') || card.classList.contains('matched')) {
                return;
            }
            
            card.classList.add('flipped');
            
            if (gameType === 'colors') {
                card.classList.add(card.dataset.class);
                card.textContent = card.dataset.value;
            } else {
                card.textContent = card.dataset.value;
            }
            
            flippedCards.push(card);
            
            if (flippedCards.length === 2) {
                setTimeout(() => checkMatch(gameType), 1000);
            }
        }

        function checkMatch(gameType) {
            const [card1, card2] = flippedCards;
            
            if (card1.dataset.value === card2.dataset.value) {
                // Match found
                card1.classList.add('matched');
                card2.classList.add('matched');
                scores[currentPlayer]++;
                matchedPairs++;
                
                updateScores(gameType);
                
                if (matchedPairs === 6) {
                    // Game completed
                    clearInterval(timerInterval);
                    setTimeout(() => {
                        currentPlayer = 0;
                        nextGame();
                    }, 2000);
                }
            } else {
                // No match
                card1.classList.remove('flipped');
                card2.classList.remove('flipped');
                
                if (gameType === 'colors') {
                    card1.classList.remove(card1.dataset.class);
                }
                
                card1.textContent = '';
                card2.textContent = '';
                
                // Move to next player
                nextPlayer();
                if (currentPlayer === 0) {
                    nextGame();
                } else {
                    startGame(currentGame);
                }
            }
            
            flippedCards = [];
        }

        // Writing game functions
        function startWritingGame(gameIndex) {
            const gameTypes = ['colors', 'animals', 'emotions'];
            const gameType = gameTypes[gameIndex];
            
            updatePlayerInfo(`write-${gameType}`);
            showRandomItem(gameType);
            startTimer(`write-${gameType}`);
            
            // Clear previous input and feedback
            document.getElementById(`input-write-${gameType}`).value = '';
            document.getElementById(`feedback-write-${gameType}`).innerHTML = '';
            
            // Add enter key listener
            const input = document.getElementById(`input-write-${gameType}`);
            input.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    checkWritingAnswer(gameType);
                }
            };
        }

        function showRandomItem(gameType) {
            let gameData, randomItem;
            
            if (gameType === 'colors') {
                gameData = colors;
                randomItem = gameData[Math.floor(Math.random() * gameData.length)];
                currentAnswer = `${randomItem.english} / ${randomItem.spanish}`;
                
                const display = document.getElementById('display-write-colors');
                display.className = `writing-display color ${randomItem.class}`;
                display.textContent = randomItem.spanish;
            } else if (gameType === 'animals') {
                gameData = animals;
                randomItem = gameData[Math.floor(Math.random() * gameData.length)];
                currentAnswer = `${randomItem.english} / ${randomItem.spanish}`;
                
                const display = document.getElementById('display-write-animals');
                display.textContent = randomItem.emoji;
            } else if (gameType === 'emotions') {
                gameData = emotions;
                randomItem = gameData[Math.floor(Math.random() * gameData.length)];
                currentAnswer = `${randomItem.english} / ${randomItem.spanish}`;
                
                const display = document.getElementById('display-write-emotions');
                display.textContent = randomItem.emoji;
            }
        }

        function checkWritingAnswer(gameType) {
            const input = document.getElementById(`input-write-${gameType}`);
            const feedback = document.getElementById(`feedback-write-${gameType}`);
            const userAnswer = input.value.trim();
            
            clearInterval(timerInterval);
            
            if (userAnswer.toLowerCase() === currentAnswer.toLowerCase()) {
                // Correct answer
                scores[currentPlayer]++;
                feedback.className = 'feedback correct';
                feedback.textContent = '¬°Correcto! +1 punto';
                updateScores(`write-${gameType}`);
            } else {
                // Incorrect answer
                errors[currentPlayer]++;
                feedback.className = 'feedback incorrect';
                feedback.textContent = `Incorrecto. La respuesta correcta era: ${currentAnswer}`;
            }
            
            setTimeout(() => {
                nextPlayer();
                if (currentPlayer === 0) {
                    nextGame();
                } else {
                    startGame(currentGame);
                }
            }, 3000);
        }

        function showIncorrectAnswer() {
            const gameTypes = ['colors', 'animals', 'emotions'];
            const gameType = gameTypes[currentGame - 3];
            const feedback = document.getElementById(`feedback-write-${gameType}`);
            
            errors[currentPlayer]++;
            feedback.className = 'feedback incorrect';
            feedback.textContent = `Tiempo agotado. La respuesta correcta era: ${currentAnswer}`;
        }

        // UI update functions
        function updatePlayerInfo(gameType) {
            document.getElementById(`current-player-${gameType}`).textContent = participants[currentPlayer];
            updateScores(gameType);
        }

        function updateScores(gameType) {
            const scoresContainer = document.getElementById(`scores-${gameType}`);
            scoresContainer.innerHTML = participants.map((name, index) => 
                `<div class="score-item">${name}: ${scores[index]} puntos</div>`
            ).join('');
        }

        // Final results
        function showFinalResults() {
            showScreen('final-results');
            
            // Create results array with participants and their stats
            const results = participants.map((name, index) => ({
                name: name,
                points: scores[index],
                errors: errors[index],
                index: index
            }));
            
            // Sort by points (descending), then by errors (ascending)
            results.sort((a, b) => {
                if (b.points !== a.points) {
                    return b.points - a.points;
                }
                return a.errors - b.errors;
            });
            
            const tbody = document.getElementById('final-results-body');
            tbody.innerHTML = results.map((result, position) => 
                `<tr${position === 0 ? ' class="winner-row"' : ''}>
                    <td>${result.name}</td>
                    <td>${result.points}</td>
                    <td>${result.errors}</td>
                    <td>${position + 1}¬∞</td>
                </tr>`
            ).join('');
        }

        // Utility functions
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function resetGame() {
            participants = [];
            scores = [];
            errors = [];
            currentPlayer = 0;
            currentGame = 0;
            timer = 70;
            clearInterval(timerInterval);
            showScreen('rules-screen');
            updateParticipantsList();
        }

        // Add enter key support for participant input
        document.getElementById('participant-name').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addParticipant();
            }
        });
        // Funci√≥n para cargar el perfil de usuario
        function cargarPerfil() {
            try {
                const perfilGuardado = localStorage.getItem('userProfile');
                if (perfilGuardado) {
                    const perfil = JSON.parse(perfilGuardado);
                    
                    // Verificar si los elementos existen antes de asignar valores
                    const profileNameInput = document.getElementById('profile-name');
                    const avatarPlaceholder = document.getElementById('avatar-placeholder');
                    const profileColorInput = document.getElementById('profile-color');
                    
                    if (profileNameInput) profileNameInput.value = perfil.nombre;
                    if (avatarPlaceholder) avatarPlaceholder.textContent = perfil.avatar;
                    if (profileColorInput) profileColorInput.value = perfil.color;
                    
                    // Actualizar nombre en las pantallas de crear y unirse a sala
                    const hostNameInputs = document.querySelectorAll('.host-name-input');
                    hostNameInputs.forEach(input => {
                        input.value = perfil.nombre;
                    });
                }
            } catch (error) {
                console.error('Error al cargar el perfil:', error);
            }
        }
        
        // Inicializar perfil al cargar la p√°gina
        window.addEventListener('load', function() {
            setTimeout(cargarPerfil, 500); // Peque√±o retraso para asegurar que todos los elementos est√©n cargados
        });
    </script>
</body>
</html>